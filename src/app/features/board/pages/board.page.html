<section class="board" aria-labelledby="board-heading">
  <div class="board__overview">
    <mat-card class="board__summary">
      <mat-card-header>
        <div mat-card-avatar class="board__summary-avatar">
          <mat-icon fontSet="material-symbols-rounded">view_kanban</mat-icon>
        </div>
        <mat-card-title id="board-heading">Missões em andamento</mat-card-title>
        <mat-card-subtitle>
          Visual moderno, métricas avançadas e recompensas compartilhadas para manter o squad engajado.
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="board__summary-grid">
          <div class="board__actions" role="group" aria-label="Ações rápidas do quadro">
            <button type="button" mat-flat-button color="primary" (click)="openCreateStory()">
              <mat-icon fontSet="material-symbols-rounded">add_circle</mat-icon>
              Nova história
            </button>
            <button type="button" mat-stroked-button color="accent">
              <mat-icon fontSet="material-symbols-rounded">playlist_add</mat-icon>
              Nova tarefa
            </button>
          </div>

          <div class="board__progress" role="status" aria-live="polite">
            <mat-chip-set class="board__level-chip-set">
              <mat-chip class="board__level-chip" color="primary" selected>
                <mat-icon matChipAvatar fontSet="material-symbols-rounded">workspace_premium</mat-icon>
                Guilda nível {{ summary().level }}
              </mat-chip>
            </mat-chip-set>
            <mat-progress-bar mode="determinate" [value]="summary().xpProgressPercent"></mat-progress-bar>
            <p>
              {{ summary().xpEarned }} XP acumulado · faltam {{ summary().xpToNextLevel }} XP para o próximo emblema
            </p>
          </div>

          <mat-divider class="board__divider"></mat-divider>

          <div class="board__stats">
            <mat-chip-set>
              <mat-chip class="board__stats-chip" color="primary" selected>
                <mat-icon matChipAvatar fontSet="material-symbols-rounded">task_alt</mat-icon>
                Histórias concluídas: {{ summary().completedStories }}
              </mat-chip>
              <mat-chip class="board__stats-chip" color="primary" selected>
                <mat-icon matChipAvatar fontSet="material-symbols-rounded">hub</mat-icon>
                Features ativas: {{ summary().activeFeatures }}
              </mat-chip>
              <mat-chip class="board__stats-chip" color="primary" selected>
                <mat-icon matChipAvatar fontSet="material-symbols-rounded">monitoring</mat-icon>
                Throughput semanal: {{ summary().weeklyThroughput }}
              </mat-chip>
            </mat-chip-set>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card *ngIf="summary().missions.length > 0" class="board__missions" aria-label="Missões em destaque">
      <mat-card-header>
        <mat-card-title>Missões</mat-card-title>
        <mat-card-subtitle>Objetivos que destravam recompensas extras para a guilda.</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="board__missions-list">
          <article class="mission" *ngFor="let mission of summary().missions">
            <div class="mission__info">
              <mat-icon aria-hidden="true" fontSet="material-symbols-rounded">auto_awesome</mat-icon>
              <div>
                <p class="mission__title">{{ mission.title }}</p>
                <p class="mission__target">{{ mission.target }}</p>
              </div>
            </div>
            <span class="mission__reward">{{ mission.reward }}</span>
            <mat-progress-bar
              class="mission__progress"
              mode="determinate"
              [value]="mission.progress * 100"
              [attr.aria-label]="'Progresso ' + (mission.progress * 100 | number: '1.0-0') + '%'"
            ></mat-progress-bar>
          </article>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <section class="board__toolbar" aria-label="Filtros das tarefas">
    <div class="board__filters" role="region" aria-label="Filtrar tarefas por sprint">
      <mat-form-field appearance="fill" class="board__filter">
        <mat-label>Sprint</mat-label>
        <mat-select [value]="selectedSprintId()" (valueChange)="onSprintFilterSelected($event)">
          <mat-option *ngFor="let option of sprintOptions()" [value]="option.id">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </section>

  <mat-card class="board__conversations" aria-label="Discussões recentes do quadro">
    <mat-card-header>
      <mat-card-title>Discussões recentes</mat-card-title>
      <mat-card-subtitle>Mantenha a guilda informada e destaque menções críticas.</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <section class="board__conversation-form" aria-label="Publicar novo comentário rápido">
        <form
          class="board__conversation-form-fields"
          [formGroup]="quickCommentForm"
          (ngSubmit)="onSubmitQuickComment()"
          aria-describedby="board-conversation-hint"
          novalidate
        >
          <div class="board__conversation-row">
            <mat-form-field appearance="fill">
              <mat-label>História</mat-label>
              <mat-select formControlName="storyId" required aria-required="true">
                <mat-option *ngFor="let option of storyOptions()" [value]="option.id">
                  {{ option.title }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="fill">
              <mat-label>Autor</mat-label>
              <input
                matInput
                type="text"
                formControlName="author"
                required
                aria-required="true"
                placeholder="Nome de quem publica"
              />
              <mat-hint id="board-conversation-hint">Use &#64; para mencionar colegas e ativar alertas.</mat-hint>
            </mat-form-field>
          </div>

          <mat-form-field appearance="fill" class="board__conversation-message">
            <mat-label>Mensagem</mat-label>
            <textarea
              matInput
              formControlName="message"
              rows="3"
              required
              aria-required="true"
              placeholder="Compartilhe atualizações e menções relevantes"
            ></textarea>
          </mat-form-field>

          <div class="board__conversation-actions">
            <button type="submit" mat-flat-button color="primary">
              <mat-icon fontSet="material-symbols-rounded" aria-hidden="true">send</mat-icon>
              Publicar atualização
            </button>
          </div>
        </form>
      </section>

      <section class="board__conversation-thread" aria-label="Comentários mais recentes">
        <ol *ngIf="recentComments().length > 0; else emptyComments" class="board__comment-list">
          <li
            *ngFor="let entry of recentComments(); trackBy: trackRecentComment"
            class="board__comment-item"
          >
            <article>
              <header class="board__comment-header">
                <span class="board__comment-author">{{ entry.comment.author }}</span>
                <span class="board__comment-story">
                  {{ entry.storyTitle }} ·
                  <time [attr.datetime]="entry.comment.createdAtIso">
                    {{ entry.comment.createdAtIso | date: 'short' }}
                  </time>
                </span>
              </header>
              <p class="board__comment-message">{{ entry.comment.message }}</p>
              <div
                *ngIf="entry.comment.mentions.length > 0"
                class="board__comment-mentions"
                aria-label="Menções registradas"
              >
                <mat-chip-set>
                  <mat-chip *ngFor="let mention of entry.comment.mentions" color="primary" selected>
                    &#64;{{ mention }}
                  </mat-chip>
                </mat-chip-set>
              </div>
            </article>
          </li>
        </ol>
        <ng-template #emptyComments>
          <p class="board__comment-empty" role="status">
            Ainda não temos conversas registradas aqui. Que tal iniciar uma atualização para o squad?
          </p>
        </ng-template>
      </section>
    </mat-card-content>
  </mat-card>

  <section class="board__columns" role="list">
    <kanban-board-column
      *ngFor="let column of columns(); trackBy: trackColumn"
      [column]="column"
      role="listitem"
    ></kanban-board-column>
  </section>

  <kanban-create-story-modal
    *ngIf="isCreatingStory()"
    [features]="features()"
    [statusOptions]="statusOptions()"
    [sprints]="sprints()"
    [activeSprintId]="selectedSprintId()"
    (dismissed)="closeCreateStory()"
    (submitted)="onStorySubmitted($event)"
  ></kanban-create-story-modal>
</section>
